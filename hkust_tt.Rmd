---
title: "hk_tumortracer"
author: "Poh Jie"
date: "20/12/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(caret)
library(data.table)
library(dplyr)
library(qdapTools)
library(Matrix.utils)
library(bit64)

library(e1071)
library(keras)

```

Functions
```{r functions, echo=FALSE}
mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```

## This Markdown document is to follow the study published by The Hong Kong University of Science and Technology. My previous document did not follow the steps outlined in the research paper.

# I believe the sample name corresponds to the "specimens" as mentioned in the research paper. However, I have more samples than listed (355135 in my data vs 235589 in the research paper).

Reading input ('CosmicMutantExport.tsv')

```{r input, echo=FALSE}

mutant_export <- fread('CosmicMutantExport.tsv', sep = '\t', header = TRUE, na.strings=c("", " ", "-", "NA", "NaN"), check.names = TRUE)

```

Preprocessing of data

According to the research paper, we are supposed to remove "227,512 specimens not labeled as “Genome.wide.screen” and 5,064 specimens labeled as cell-line (in union 227,757 specimens)".

We shall begin by removing those labeled 'n' for "Genome.wide.screen".
```{r preprocessing_easy, echo=FALSE}

mutant_export <- mutant_export[Genome.wide.screen =='y' & Sample.Type != 'cell-line' & Mutation.Description != 'Substitution - coding silent', ]

```

Next, we move on to the tougher preprocessing part, whereby we want all tumour ID to have only 1 specimen.

```{r preprocessing_hard, echo=FALSE}

good_tumor_sample <- mutant_export[,{
  uniq_sample <- unique(ID_sample)
  crit_1 <- Sample.Type != 'xenograft'
  crit_2 <- Mutation.somatic.status == 'Confirmed somatic variant'
  crit_3 <- Tumour.origin == 'primary'
  crit_all <- crit_1 & crit_2 & crit_3
  chosen_sample <- 0L
  if (length(uniq_sample) > 1) {
    if (any(crit_all)) {
      chosen_sample <- sample(ID_sample[crit_all], 1)
    }
  } else {
    chosen_sample <- uniq_sample
  }
  list(ID_sample_picked = chosen_sample)
},by=ID_tumour]

good_tumor_sample2 <- good_tumor_sample[ID_sample_picked != 0, .(tumor_sample_ID=paste(ID_tumour, ID_sample_picked, sep = "$"))]

mutant_export[,tumor_sample_ID:=paste(ID_tumour, ID_sample, sep = "$")]

mutant_export_cleaned <- mutant_export[tumor_sample_ID %in% good_tumor_sample2$tumor_sample_ID,]

```

Now that we have preprocessed the data, the next stage is to prepare the X and Y. 

```{r one_hot_simult, echo=FALSE}
input <- select(mutant_export_cleaned, ID_tumour, Mutation.ID, Primary.site, Tumour.origin)

input$appearance <- 1
input_casted <- dMcast(input, ID_tumour ~ Mutation.ID, value.var = "appearance", fun.aggregate = "sum")

input$origin <- 1
input_origin <- dMcast(input, ID_tumour ~ Tumour.origin, value.var = 'origin')

```

```{r one_hot, echo=FALSE}
input <- select(mutant_export_cleaned, ID_tumour, Mutation.ID, Primary.site, Tumour.origin)

input$appearance <- 1
input_mutation <- dMcast(input, ID_tumour ~ Mutation.ID, value.var = "appearance", fun.aggregate = "sum")

#input_tumour_origin <- aggregate(Tumour.origin~ID_tumour, input, FUN=mode)
#input_tumour_origin <- Matrix(as.matrix(input_tumour_origin), sparse=TRUE)

#input_primary <- dMcast(input, ID_tumour ~ Primary.site, value.var = "appearance", fun.aggregate=mode)
input_primary_site <- aggregate(Primary.site~ID_tumour, input, FUN=mode)
input_primary_site <- Matrix(as.matrix(input_primary_site), sparse=TRUE)

input_processed <- cbind(input_casted, input_primary_site, input_tumour_origin)
```

```{r train_test_split, echo=FALSE}

sample_size <- floor(0.8 * nrow(input_processed))

# set seed for reproducible results
set.seed(101)
train_indices <- sample(seq_len(nrow(input_processed)), size=sample_size)

#train_mutation <- X_casted[train_indices,]
#train_origin <- Matrix(data.matrix(X_tumour_origin[train_indices,]), sparse=TRUE)
#train_origin[is.na(train_origin)] <- 0

#train_X <- cbind(train_mutation, train_origin)
#train_y <- X_primary_site[train_indices,]

train_X <- input_processed[train_indices, names(input_processed) != 'Primary.site']
train_y <- input_processed[train_indices, 'Primary.site']

#test_mutation <- X_casted[-train_indices,]
#test_origin <- Matrix(data.matrix(X_tumour_origin[-train_indices,]), sparse=TRUE)
#test_origin[is.na(test_origin)] <- 0

#test_X <- cbind(test_mutation, test_origin)
#test_y <- X_primary_site[-train_indices,]
```

```{r svm, echo=FALSE}

svmfit = svm(x=train_X, y=train_y, kernel='linear')
```